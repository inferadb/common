# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json

name: Nightly

on:
  schedule:
    # Run at 2am UTC daily
    - cron: "0 2 * * *"
  workflow_dispatch:

# Cancel in-progress runs when new runs are triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Check if there are changes since the last nightly
  check-changes:
    name: Changes
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Check for changes since last nightly
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find the last nightly release
          LAST_NIGHTLY=$(gh release list --limit 50 | grep -E 'nightly\.' | head -1 | awk '{print $1}' || echo "")

          if [ -z "$LAST_NIGHTLY" ]; then
            echo "No previous nightly release found, will run"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get the commit SHA for the last nightly tag
          LAST_SHA=$(git rev-list -n 1 "$LAST_NIGHTLY" 2>/dev/null || echo "")

          if [ -z "$LAST_SHA" ]; then
            echo "Could not find commit for last nightly, will run"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if there are commits since the last nightly
          COMMITS_SINCE=$(git rev-list "$LAST_SHA"..HEAD --count)

          if [ "$COMMITS_SINCE" -gt 0 ]; then
            echo "Found $COMMITS_SINCE commits since last nightly, will run"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "No commits since last nightly, skipping"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # Compute nightly version from release-please manifest
  version:
    name: Version
    needs: check-changes
    if: needs.check-changes.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      date: ${{ steps.version.outputs.date }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Compute nightly version
        id: version
        run: |
          # Read next version from release-please manifest
          if [ -f ".release-please-manifest.json" ]; then
            NEXT_VERSION=$(jq -r '.["." ] // .[] | select(. != null)' .release-please-manifest.json | head -1)
          else
            NEXT_VERSION="0.1.0"
          fi

          DATE=$(date -u +%Y%m%d)
          # Use dev.YYYYMMDD format for chronological semver sorting
          NIGHTLY_VERSION="${NEXT_VERSION}-dev.${DATE}"

          echo "version=${NIGHTLY_VERSION}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT
          echo "Nightly version: ${NIGHTLY_VERSION}"

  # Publish nightly version to crates.io
  publish:
    name: Publish
    needs: version
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # stable

      # Use OIDC-based trusted publishing
      - name: Authenticate with crates.io
        uses: rust-lang/crates-io-auth-action@b7e9a28eded4986ec6b1fa40eeee8f8f165559ec # v1.0.3
        id: auth

      # Publish storage first (only patch its version, not storage-ledger's dependency)
      - name: Publish inferadb-common-storage
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
          NIGHTLY_VERSION: ${{ needs.version.outputs.version }}
        run: |
          sed -i "s/^version = \".*\"/version = \"${NIGHTLY_VERSION}\"/" crates/storage/Cargo.toml
          cargo publish --package inferadb-common-storage --token "$CARGO_REGISTRY_TOKEN" --allow-dirty

      - name: Wait for crates.io to index
        env:
          EXPECTED_VERSION: ${{ needs.version.outputs.version }}
        run: |
          # Poll crates.io until the version appears (max 5 minutes)
          for i in {1..30}; do
            if cargo search inferadb-common-storage 2>/dev/null | grep -q "${EXPECTED_VERSION%+*}"; then
              echo "Version ${EXPECTED_VERSION} is now available on crates.io"
              exit 0
            fi
            echo "Waiting for crates.io to index (attempt $i/30)..."
            sleep 10
          done
          echo "Warning: Timed out waiting for index, proceeding anyway..."

      # Patch authn's version AND dependency, then publish
      - name: Publish inferadb-common-authn
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
          NIGHTLY_VERSION: ${{ needs.version.outputs.version }}
        run: |
          sed -i "s/^version = \".*\"/version = \"${NIGHTLY_VERSION}\"/" crates/authn/Cargo.toml
          sed -i "s/^inferadb-common-storage = .*/inferadb-common-storage = \"=${NIGHTLY_VERSION}\"/" crates/authn/Cargo.toml
          cargo publish --package inferadb-common-authn --token "$CARGO_REGISTRY_TOKEN" --allow-dirty

      # Now patch storage-ledger's version AND dependency, then publish
      - name: Publish inferadb-common-storage-ledger
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
          NIGHTLY_VERSION: ${{ needs.version.outputs.version }}
        run: |
          sed -i "s/^version = \".*\"/version = \"${NIGHTLY_VERSION}\"/" crates/storage-ledger/Cargo.toml
          sed -i "s/^inferadb-common-storage = .*/inferadb-common-storage = \"=${NIGHTLY_VERSION}\"/" crates/storage-ledger/Cargo.toml
          cargo publish --package inferadb-common-storage-ledger --token "$CARGO_REGISTRY_TOKEN" --allow-dirty

  # Create GitHub pre-release for tracking
  create-release:
    name: Release
    needs: [version, publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Create Pre-Release
        uses: step-security/action-gh-release@d45511d7589f080cf54961ff056b9705a74fd160 # v2.5.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.version.outputs.version }}
          name: Nightly v${{ needs.version.outputs.version }}
          draft: false
          prerelease: true
          body: |
            **This is a nightly build for testing purposes.**

            Built from commit: ${{ github.sha }}
            Build date: ${{ needs.version.outputs.date }}

            ### Published Crates

            | Crate | Version |
            |-------|---------|
            | `inferadb-common-authn` | `${{ needs.version.outputs.version }}` |
            | `inferadb-common-storage` | `${{ needs.version.outputs.version }}` |
            | `inferadb-common-storage-ledger` | `${{ needs.version.outputs.version }}` |

            Install with Cargo:
            ```toml
            [dependencies]
            inferadb-common-authn = "=${{ needs.version.outputs.version }}"
            inferadb-common-storage = "=${{ needs.version.outputs.version }}"
            inferadb-common-storage-ledger = "=${{ needs.version.outputs.version }}"
            ```

            > **Note:** Pre-release versions require exact version matching (`=`) in Cargo.toml.

      - name: Update nightly tag
        run: |
          git tag -f nightly
          git push -f origin nightly

  # Cleanup old nightly releases (keep last 7)
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [create-release]
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Delete old nightly releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # List all nightly releases, sorted by date (newest first)
          NIGHTLIES=$(gh release list --limit 100 | grep -E 'nightly\.' | awk '{print $1}')

          # Keep the 7 most recent, delete the rest
          COUNT=0
          for TAG in $NIGHTLIES; do
            COUNT=$((COUNT + 1))
            if [ $COUNT -gt 7 ]; then
              echo "Deleting old nightly release: $TAG"
              gh release delete "$TAG" --yes --cleanup-tag || true
            fi
          done
