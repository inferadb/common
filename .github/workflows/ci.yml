# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Nightly at midnight UTC (for coverage)
    - cron: "0 0 * * *"

# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Default to read-only permissions
permissions:
  contents: read
  pull-requests: read

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: 1

jobs:
  # Validate conventional commit messages
  commits:
    name: Commit Messages
    runs-on: ubuntu-latest
    # Only run on pull requests - push to main is already validated
    if: github.event_name == 'pull_request'
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@0723387faaf9b38adef4775cd42cfd5155ed6017 # v5.5.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
          requireScope: false
          subjectPattern: ^[a-z].*$
          subjectPatternError: |
            The subject "{subject}" must start with a lowercase letter.
            Example: "feat: add user authentication" or "fix(api): handle empty requests"

  # Check code formatting
  fmt:
    name: Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust nightly toolchain
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # nightly
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo +nightly fmt --all -- --check

  # Run Clippy for linting
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-C codegen-units=16 -C link-arg=-fuse-ld=mold"
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # stable
        with:
          components: clippy

      - name: Install mold linker
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq mold

      - name: Cache Rust dependencies
        uses: step-security/rust-cache@f8fba7098297c8c53a7c9a30575ec2ad4ad85056 # v2.8.2
        with:
          shared-key: clippy

      - name: Run clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

  # Check for unused dependencies
  udeps:
    name: Unused Dependencies
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-C codegen-units=16 -C link-arg=-fuse-ld=mold"
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust nightly toolchain
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # nightly

      - name: Install mold linker
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq mold

      - name: Install cargo-udeps
        uses: taiki-e/install-action@710817a1645ef40daad5bcde7431ceccf6cc3528 # v2.67.13
        with:
          tool: cargo-udeps
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Rust dependencies
        uses: step-security/rust-cache@f8fba7098297c8c53a7c9a30575ec2ad4ad85056 # v2.8.2
        with:
          shared-key: udeps

      - name: Check for unused dependencies
        run: cargo +nightly udeps --workspace

  # Check MSRV (Minimum Supported Rust Version)
  msrv:
    name: MSRV (1.92)
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-C codegen-units=16 -C link-arg=-fuse-ld=mold"
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust 1.92
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # master
        with:
          toolchain: "1.92"

      - name: Install mold linker
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq mold

      - name: Cache Rust dependencies
        uses: step-security/rust-cache@f8fba7098297c8c53a7c9a30575ec2ad4ad85056 # v2.8.2
        with:
          shared-key: msrv

      - name: Check compilation
        run: cargo check --workspace

  # Run tests on multiple platforms
  test:
    name: Test (${{ matrix.os }})
    needs: [fmt, clippy]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm, macos-latest]
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # stable

      - name: Install mold linker (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq mold

      - name: Install cargo-nextest
        uses: taiki-e/install-action@710817a1645ef40daad5bcde7431ceccf6cc3528 # v2.67.13
        with:
          tool: cargo-nextest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Rust dependencies
        uses: step-security/rust-cache@f8fba7098297c8c53a7c9a30575ec2ad4ad85056 # v2.8.2
        with:
          shared-key: test-${{ matrix.os }}

      - name: Run unit tests
        env:
          RUSTFLAGS: ${{ runner.os == 'Linux' && '-C codegen-units=16 -C link-arg=-fuse-ld=mold' || '-C codegen-units=16' }}
        run: cargo nextest run --workspace --lib

      - name: Run doc tests
        run: cargo test --workspace --doc

  # Code coverage (nightly only to reduce CI costs)
  coverage:
    name: Code Coverage
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    continue-on-error: true
    env:
      RUSTFLAGS: "-C codegen-units=16 -C link-arg=-fuse-ld=mold"
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # stable
        with:
          components: llvm-tools-preview

      - name: Install mold linker
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq mold

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@710817a1645ef40daad5bcde7431ceccf6cc3528 # v2.67.13
        with:
          tool: cargo-llvm-cov
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Rust dependencies
        uses: step-security/rust-cache@f8fba7098297c8c53a7c9a30575ec2ad4ad85056 # v2.8.2
        with:
          shared-key: coverage

      - name: Generate coverage
        run: |
          cargo llvm-cov --workspace --lib \
            --codecov \
            --output-path codecov.json

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          files: ./codecov.json
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # Build documentation
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-C codegen-units=16 -C link-arg=-fuse-ld=mold"
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust nightly toolchain
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # nightly

      - name: Install mold linker
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq mold

      - name: Cache Rust dependencies
        uses: step-security/rust-cache@f8fba7098297c8c53a7c9a30575ec2ad4ad85056 # v2.8.2
        with:
          shared-key: docs

      - name: Build documentation
        env:
          RUSTDOCFLAGS: -D warnings --cfg docsrs
        run: cargo +nightly doc --workspace --no-deps

  # Storage Backend Benchmarks
  # Runs MemoryBackend benchmarks on every PR and saves baselines on main.
  # Compares against main baseline and alerts on >10% regression.
  benchmark:
    name: Storage Benchmarks
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      RUSTFLAGS: "-C codegen-units=16 -C link-arg=-fuse-ld=mold"
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # stable

      - name: Install mold linker
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq mold

      - name: Cache Rust dependencies
        uses: step-security/rust-cache@f8fba7098297c8c53a7c9a30575ec2ad4ad85056 # v2.8.2
        with:
          shared-key: benchmark
          save-if: false

      # Download baseline from main branch (if exists)
      - name: Download baseline artifact
        if: github.event_name == 'pull_request'
        uses: dawidd6/action-download-artifact@07ab29fd4a977ae4d2b275087cf67563dfdf0295 # v9
        with:
          workflow: ci.yml
          branch: main
          name: benchmark-baseline
          path: target/criterion-baseline
        continue-on-error: true

      # Run benchmarks with baseline comparison on PRs
      - name: Run benchmarks (PR - compare to baseline)
        if: github.event_name == 'pull_request'
        id: bench-pr
        run: |
          mkdir -p target/criterion
          # Check if baseline exists
          if [ -d "target/criterion-baseline" ]; then
            echo "Baseline found, running comparison benchmarks"
            # Copy baseline to criterion directory
            cp -r target/criterion-baseline/* target/criterion/ 2>/dev/null || true
            # Run benchmarks with comparison
            cargo bench -p inferadb-common-storage 2>&1 | tee benchmark-output.txt
            echo "baseline_exists=true" >> $GITHUB_OUTPUT
          else
            echo "No baseline found, running benchmarks without comparison"
            cargo bench -p inferadb-common-storage 2>&1 | tee benchmark-output.txt
            echo "baseline_exists=false" >> $GITHUB_OUTPUT
          fi

      # Save baseline on main branch
      - name: Run benchmarks (main - save baseline)
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p target/criterion
          cargo bench -p inferadb-common-storage -- --save-baseline main 2>&1 | tee benchmark-output.txt

      # Check for performance regressions (>10%)
      - name: Check for performance regressions
        if: github.event_name == 'pull_request' && steps.bench-pr.outputs.baseline_exists == 'true'
        id: regression-check
        run: |
          # Parse benchmark output for regressions
          # Criterion outputs "Performance has regressed." when there's a regression
          # and shows percentage changes like "+12.34%"

          REGRESSIONS=""
          while IFS= read -r line; do
            # Look for lines with significant regressions (>10%)
            if echo "$line" | grep -E '\+[0-9]+\.[0-9]+%' | grep -v "change:" > /dev/null; then
              # Extract the percentage
              PCT=$(echo "$line" | grep -oE '\+[0-9]+\.[0-9]+%' | head -1 | tr -d '+%')
              if [ -n "$PCT" ]; then
                # Check if regression is > 10%
                if awk "BEGIN {exit !($PCT > 10)}"; then
                  REGRESSIONS="${REGRESSIONS}\n${line}"
                fi
              fi
            fi
          done < benchmark-output.txt

          if [ -n "$REGRESSIONS" ]; then
            echo "regression_found=true" >> $GITHUB_OUTPUT
            echo "regressions<<EOF" >> $GITHUB_OUTPUT
            echo -e "$REGRESSIONS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "::warning::Performance regressions detected (>10%)"
          else
            echo "regression_found=false" >> $GITHUB_OUTPUT
            echo "No significant regressions detected"
          fi

      # Post regression warning comment on PR
      - name: Comment on PR with regression warning
        if: github.event_name == 'pull_request' && steps.regression-check.outputs.regression_found == 'true'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const regressions = `${{ steps.regression-check.outputs.regressions }}`;
            const body = `## Performance Regression Warning

            The following benchmarks show >10% performance regression compared to main:

            \`\`\`
            ${regressions}
            \`\`\`

            Please review these changes carefully. If the regression is expected (e.g., due to added functionality), please note this in the PR description.

            <details>
            <summary>Full benchmark output</summary>

            See the workflow artifacts for complete benchmark results.
            </details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      # Upload benchmark results as artifacts
      - name: Upload benchmark results
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: benchmark-results
          path: |
            benchmark-output.txt
            target/criterion/
          retention-days: 30

      # Save baseline for future PRs (only on main)
      - name: Upload baseline artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: benchmark-baseline
          path: target/criterion/
          retention-days: 90

  # Overall status check
  ci-success:
    name: CI Success
    needs: [commits, fmt, clippy, udeps, msrv, test, coverage, docs, benchmark]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Check all jobs
        env:
          FMT_RESULT: ${{ needs.fmt.result }}
          CLIPPY_RESULT: ${{ needs.clippy.result }}
          UDEPS_RESULT: ${{ needs.udeps.result }}
          MSRV_RESULT: ${{ needs.msrv.result }}
          TEST_RESULT: ${{ needs.test.result }}
          DOCS_RESULT: ${{ needs.docs.result }}
          COVERAGE_RESULT: ${{ needs.coverage.result }}
          BENCHMARK_RESULT: ${{ needs.benchmark.result }}
        run: |
          # Commits check is only required on PRs
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ needs.commits.result }}" != "success" ]]; then
              echo "Commit message validation failed"
              echo "PR title must follow Conventional Commits format:"
              echo "  <type>(<scope>): <description>"
              echo "  Examples: 'feat: add new feature' or 'fix(api): handle edge case'"
              exit 1
            fi
          fi

          results="$FMT_RESULT $CLIPPY_RESULT $UDEPS_RESULT $MSRV_RESULT $TEST_RESULT $DOCS_RESULT"

          for result in $results; do
            if [[ "$result" != "success" && "$result" != "skipped" ]]; then
              echo "One or more jobs failed"
              exit 1
            fi
          done

          # Coverage and benchmarks are optional
          if [[ "$COVERAGE_RESULT" == "failure" ]]; then
            echo "Coverage failed (non-blocking)"
          fi
          if [[ "$BENCHMARK_RESULT" == "failure" ]]; then
            echo "Benchmark failed (non-blocking)"
          fi

          echo "All required checks passed!"
