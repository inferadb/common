# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json

name: Release

on:
  # Called by release-please when a release PR is merged
  workflow_call:
    inputs:
      tag_name:
        description: "Release tag (e.g., v1.0.0)"
        type: string
        required: true
      version:
        description: "Release version (e.g., 1.0.0)"
        type: string
        required: true
  # Manual trigger for hotfix releases
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.0)"
        required: true

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Determine version from trigger source
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Determine version
        id: version
        env:
          CALL_VERSION: ${{ inputs.version }}
          CALL_TAG: ${{ inputs.tag_name }}
          DISPATCH_VERSION: ${{ github.event.inputs.version }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            # Manual trigger - version includes 'v' prefix
            VERSION="${DISPATCH_VERSION#v}"
            TAG_NAME="v${VERSION}"
          else
            # Called from release-please
            VERSION="$CALL_VERSION"
            TAG_NAME="$CALL_TAG"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag_name=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "Release version: ${VERSION}, tag: ${TAG_NAME}"

  # Create GitHub release (only for workflow_dispatch; release-please creates its own)
  create-release:
    name: Release
    needs: prepare
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Create Release
        uses: step-security/action-gh-release@d45511d7589f080cf54961ff056b9705a74fd160 # v2.5.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare.outputs.tag_name }}
          name: Release ${{ needs.prepare.outputs.tag_name }}
          draft: false
          prerelease: false
          generate_release_notes: true

  # Update rolling latest tag
  update-latest-tag:
    name: Latest Tag
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Update latest tag
        run: |
          git tag -f latest
          git push -f origin latest

  # Publish to crates.io
  publish:
    name: Publish
    needs: prepare
    runs-on: ubuntu-latest
    environment: release
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # stable
        with:
          toolchain: stable

      # Use OIDC-based trusted publishing
      - name: Authenticate with crates.io
        uses: rust-lang/crates-io-auth-action@b7e9a28eded4986ec6b1fa40eeee8f8f165559ec # v1.0.3
        id: auth

      - name: Publish inferadb-common-storage
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          cargo publish --package inferadb-common-storage --token "$CARGO_REGISTRY_TOKEN"

      - name: Wait for crates.io to index
        env:
          EXPECTED_VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          # Poll crates.io until the version appears (max 5 minutes)
          for i in {1..30}; do
            if cargo search inferadb-common-storage 2>/dev/null | grep -q "${EXPECTED_VERSION}"; then
              echo "Version ${EXPECTED_VERSION} is now available on crates.io"
              exit 0
            fi
            echo "Waiting for crates.io to index (attempt $i/30)..."
            sleep 10
          done
          echo "Warning: Timed out waiting for index, proceeding anyway..."

      - name: Publish inferadb-common-storage-ledger
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          cargo publish --package inferadb-common-storage-ledger --token "$CARGO_REGISTRY_TOKEN"

  # Build documentation (triggers docs.rs automatically on crates.io publish)
  docs:
    name: Docs
    needs: [prepare, publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # stable
        with:
          toolchain: nightly

      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq protobuf-compiler

      - name: Cache Rust dependencies
        uses: step-security/rust-cache@9be15b830520fab0ec3939586e917e4855cf76bd # v2.8.3

      - name: Build documentation
        env:
          RUSTDOCFLAGS: --cfg docsrs
        run: cargo +nightly doc --workspace --no-deps --all-features

      - name: Upload documentation artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: documentation
          path: target/doc
          retention-days: 30
