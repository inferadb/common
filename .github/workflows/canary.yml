# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json

name: Canary

on:
  push:
    branches:
      - main
    paths:
      - "crates/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/canary.yml"
  workflow_dispatch:

# Cancel in-progress runs when new runs are triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Compute canary version from release-please manifest
  version:
    name: Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      short_sha: ${{ steps.version.outputs.short_sha }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Compute canary version
        id: version
        run: |
          # Read next version from release-please manifest
          if [ -f ".release-please-manifest.json" ]; then
            NEXT_VERSION=$(jq -r '.["." ] // .[] | select(. != null)' .release-please-manifest.json | head -1)
          else
            NEXT_VERSION="0.1.0"
          fi

          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          CANARY_VERSION="${NEXT_VERSION}-canary.${{ github.run_number }}+${SHORT_SHA}"

          echo "version=${CANARY_VERSION}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Canary version: ${CANARY_VERSION}"

  # Publish canary versions to crates.io
  publish:
    name: Publish
    needs: version
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # stable
        with:
          toolchain: stable

      - name: Patch crate versions
        env:
          CANARY_VERSION: ${{ needs.version.outputs.version }}
        run: |
          # Patch versions in Cargo.toml files
          sed -i "s/^version = \".*\"/version = \"${CANARY_VERSION}\"/" crates/storage/Cargo.toml
          sed -i "s/^version = \".*\"/version = \"${CANARY_VERSION}\"/" crates/storage-ledger/Cargo.toml

          # Update storage-ledger's dependency on storage to use exact canary version
          sed -i "s/^inferadb-common-storage = .*/inferadb-common-storage = \"=${CANARY_VERSION}\"/" crates/storage-ledger/Cargo.toml

          echo "Patched versions:"
          grep -r "^version = " crates/*/Cargo.toml
          grep "inferadb-common-storage" crates/storage-ledger/Cargo.toml

      # Use OIDC-based trusted publishing
      - name: Authenticate with crates.io
        uses: rust-lang/crates-io-auth-action@b7e9a28eded4986ec6b1fa40eeee8f8f165559ec # v1.0.3
        id: auth

      - name: Publish crates
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          # Publish storage crate first (base crate)
          echo "Publishing inferadb-common-storage..."
          cargo publish --package inferadb-common-storage --token "$CARGO_REGISTRY_TOKEN" --allow-dirty

          # Wait for crates.io to index
          echo "Waiting for crates.io to index..."
          sleep 45

          # Publish storage-ledger (depends on storage)
          echo "Publishing inferadb-common-storage-ledger..."
          cargo publish --package inferadb-common-storage-ledger --token "$CARGO_REGISTRY_TOKEN" --allow-dirty
          # That crate will be publishable once the full release pipeline is in place.

  # Create GitHub pre-release for tracking
  create-release:
    name: Release
    needs: [version, publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Create Pre-Release
        uses: step-security/action-gh-release@d45511d7589f080cf54961ff056b9705a74fd160 # v2.5.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.version.outputs.version }}
          name: Canary v${{ needs.version.outputs.version }}
          draft: false
          prerelease: true
          body: |
            ⚠️ **This is a canary release for testing purposes.**

            Built from commit: ${{ github.sha }}

            ### Published Crates

            | Crate | Version |
            |-------|---------|
            | `inferadb-common-storage` | `${{ needs.version.outputs.version }}` |
            | `inferadb-common-storage-ledger` | `${{ needs.version.outputs.version }}` |

            Install with Cargo:
            ```toml
            [dependencies]
            inferadb-common-storage = "=${{ needs.version.outputs.version }}"
            inferadb-common-storage-ledger = "=${{ needs.version.outputs.version }}"
            ```

            > **Note:** Pre-release versions require exact version matching (`=`) in Cargo.toml.

      - name: Update floating canary tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete existing canary tag if it exists
          git push origin :refs/tags/canary 2>/dev/null || true

          # Create new canary tag pointing to current commit
          git tag -f canary
          git push origin canary
