# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json

name: Canary

on:
  push:
    branches:
      - main
    paths:
      - "crates/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/canary.yml"
  workflow_dispatch:

# Cancel in-progress runs when new runs are triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Compute canary version from release-please manifest
  version:
    name: Compute Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      short_sha: ${{ steps.version.outputs.short_sha }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Compute canary version
        id: version
        run: |
          # Read next version from release-please manifest
          if [ -f ".release-please-manifest.json" ]; then
            NEXT_VERSION=$(jq -r '.["." ] // .[] | select(. != null)' .release-please-manifest.json | head -1)
          else
            NEXT_VERSION="0.1.0"
          fi

          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          CANARY_VERSION="${NEXT_VERSION}-canary.${{ github.run_number }}+${SHORT_SHA}"

          echo "version=${CANARY_VERSION}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Canary version: ${CANARY_VERSION}"

  # Publish canary versions to crates.io
  publish:
    name: Publish to crates.io
    needs: version
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable

      - name: Patch crate versions
        run: |
          CANARY_VERSION="${{ needs.version.outputs.version }}"

          # Patch version in Cargo.toml (sed bypasses cargo-edit's semver downgrade check)
          sed -i "s/^version = \".*\"/version = \"${CANARY_VERSION}\"/" crates/storage/Cargo.toml

          echo "Patched versions:"
          grep -r "^version = " crates/*/Cargo.toml

      # Use OIDC-based trusted publishing
      - name: Authenticate with crates.io
        uses: rust-lang/crates-io-auth-action@b7e9a28eded4986ec6b1fa40eeee8f8f165559ec # v1.0.3
        id: auth

      - name: Publish inferadb-common-storage
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          # Publish storage crate (base crate with no external path dependencies)
          cargo publish --package inferadb-common-storage --token "$CARGO_REGISTRY_TOKEN" --allow-dirty

          # Note: inferadb-common-storage-ledger is NOT published because it has
          # a path dependency on inferadb-ledger-sdk which is in a different repo.
          # That crate will be publishable once the full release pipeline is in place.

  # Create GitHub pre-release for tracking
  create-release:
    name: Create Pre-Release
    needs: [version, publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Create Pre-Release
        uses: step-security/action-gh-release@674f8f866246c6b91bd3f1688ba95e27b2ae8d2e # v2.4.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.version.outputs.version }}
          name: Canary v${{ needs.version.outputs.version }}
          draft: false
          prerelease: true
          body: |
            ⚠️ **This is a canary release for testing purposes.**

            Built from commit: ${{ github.sha }}

            ### Published Crates

            | Crate | Version |
            |-------|---------|
            | `inferadb-common-storage` | `${{ needs.version.outputs.version }}` |

            Install with Cargo:
            ```toml
            [dependencies]
            inferadb-common-storage = "=${{ needs.version.outputs.version }}"
            ```

            > **Note:** Pre-release versions require exact version matching (`=`) in Cargo.toml.

      - name: Update floating canary tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete existing canary tag if it exists
          git push origin :refs/tags/canary 2>/dev/null || true

          # Create new canary tag pointing to current commit
          git tag -f canary
          git push origin canary
